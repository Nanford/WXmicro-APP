<!-- pages/chat/chat.wxml -->
<view class="container chat-container">
  <scroll-view 
    class="msg-list" 
    scroll-y 
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation="{{true}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    enable-flex
  >
    <block wx:for="{{messages}}" wx:key="index">
      <view class="time-tip" wx:if="{{item.time}}">{{item.time}}</view>
      
      <view id="msg-{{index}}" class="msg-item {{item.type === 'user' ? 'msg-user' : 'msg-ai'}} {{item.error ? 'msg-error' : ''}}">
        <image wx:if="{{item.type === 'ai'}}" class="avatar ai-avatar" src="/assets/ai-avatar-small.png"></image>
        
        <view class="bubble-wrapper">
          <view class="bubble">
            <text user-select>{{item.content}}</text>
          </view>
          
          <!-- Retry button for error messages -->
          <view wx:if="{{item.error}}" class="retry-btn" bindtap="handleRetry" data-index="{{index}}">
            <text>ç‚¹å‡»é‡è¯•</text>
          </view>
        </view>
        
        <!-- User avatar could be added here if needed -->
      </view>
    </block>

    <view class="typing-indicator" wx:if="{{isTyping}}" id="typing-area">
        <text>AIæ­£åœ¨è¾“å…¥...</text>
    </view>
    
    <!-- Padding for bottom input, must be enough for input area + safe area -->
    <view id="scroll-bottom" style="height: 200rpx;"></view> 
  </scroll-view>

  <view class="input-area">
    <view class="btn-voice" bindtap="toggleVoice">
      <text>ğŸ¤</text>
    </view>
    <view class="input-box">
      <textarea 
        class="input-textarea"
        value="{{inputValue}}"
        bindinput="handleInput"
        auto-height
        fixed
        maxlength="500"
        cursor-spacing="20"
      ></textarea>
    </view>
    <view 
      class="btn-send {{inputValue ? 'active' : ''}}" 
      bindtap="handleSend"
    >å‘é€</view>
  </view>
</view>
